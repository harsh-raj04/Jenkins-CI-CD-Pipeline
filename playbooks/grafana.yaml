---
- name: Install and configure Grafana
  hosts: webservers
  become: yes

  vars:
    grafana_apt_repo: "deb https://packages.grafana.com/oss/deb stable main"
    grafana_apt_key_url: "https://packages.grafana.com/gpg.key"
    grafana_package_name: "grafana"

  tasks:

    - name: Ensure required packages are installed
      apt:
        name:
          - apt-transport-https
          - software-properties-common
          - wget
          - gnupg
        state: present
        update_cache: yes

    - name: Add Grafana GPG key
      ansible.builtin.apt_key:
        url: "{{ grafana_apt_key_url }}"
        state: present

    - name: Add Grafana APT repository
      ansible.builtin.apt_repository:
        repo: "{{ grafana_apt_repo }}"
        state: present
        filename: grafana

    - name: Update APT cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Install Grafana
      ansible.builtin.apt:
        name: "{{ grafana_package_name }}"
        state: present

    - name: Enable and start Grafana service
      ansible.builtin.systemd:
        name: grafana-server
        enabled: yes
        state: started

    - name: Allow Grafana port 3000 through UFW
      ansible.builtin.ufw:
        rule: allow
        port: "3000"
        proto: tcp
      when: ansible_facts['os_family'] == "Debian" and ('ufw' in (ansible_facts['packages'] | default({})))
